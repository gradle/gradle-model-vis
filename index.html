<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
    <style>
        svg {
            font-size: 8pt;
            font-family: monospace;
        }

        .node {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 1.5px;
        }

        .link {
            stroke: #999;
            stroke-opacity: .6;
        }

        text {
            stroke: none;
            fill: black;
        }

        .controls,
        .controls button {
            font-family: monospace;
            font-size: 10pt;
        }
    </style>

    <script src="lib/d3.v3.js"></script>
    <script src="lib/underscore.js"></script>
    <script src="lib/jquery-2.2.0.min.js"></script>
    <script src="js/layout.js"></script>
</head>
<body>
    <div class="controls">
        <button id="back">â€“</button>
        <input id="time" type="range" width="100" />
        <button id="forward">+</button>
        <button id="play-pause">&gt;&gt;</button>
    </div>
    <script>
        var width = 1000,
            height = 600;

        var stateColors = {
            Registered: "#aec7e8",
            Discovered: "#1f77b4",
            Created: "#2ca02c",
            DefaultsApplied: "#ffbb78",
            Initialized: "#ff7f0e",
            Mutated: "#d62728",
            Finalized: "#e377c2",
            SelfClosed: "#c7c7c7",
            GraphClosed: "#7f7f7f",
        };

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        var legend = svg.selectAll(".legend")
            .data(Object.keys(stateColors));

        var legendGroup = legend.enter()
            .append("g")
            .attr("class", "legend");

        var legendCircle = legendGroup.append("circle")
            .attr("r", 10)
            .attr("cx", 10)
            .attr("cy", function(d, idx) {
                return 10 + idx * 22;
            })
            .attr("fill", function(d) {
                return stateColors[d];
            });

        var legendText = legendGroup.append("text")
            .attr("x", 22)
            .attr("y", function(d, idx) {
                return 13 + idx * 22;
            })
            .text(function(d) {
                return d;
            });
        legend.exit().remove();


        var dataFile = location.hash ? location.hash.substring(1) : "samples/gradle-model.json";
        console.log("Loading data file", dataFile);

        d3.json(dataFile, function(error, events) {
            if (error) throw error;

            var layout = new Layout(width, height);

            var commands = processEvents(events, layout);
            var time = 0;

            $("#time").attr({
                min: 0,
                max: events.length
            }).val(0);
            $("#back").click(function() {
                var value = parseInt($("#time").val());
                value = Math.max(0, value - 1);
                $("#time").val(value);
                $("#time").trigger("input");
            });
            $("#forward").click(function() {
                var value = parseInt($("#time").val());
                value = Math.min(events.length, value + 1);
                $("#time").val(value);
                $("#time").trigger("input");
            });
            var playing = false;
            var $playPause = $("#play-pause");
            $playPause.click(function() {
                var stop = function() {
                    playing = false;
                    $playPause.text(">>");
                };
                if (!playing) {
                    var playLoop = function() {
                        var $time = $("#time");
                        var cur = parseInt($time.val());
                        var max = parseInt($time.attr('max'));
                        if (cur < max) {
                            $("#forward").trigger("click");
                            if (playing) setTimeout(playLoop, 200);
                        } else {
                            stop();
                        }
                    };
                    playing = true;
                    $playPause.text("||");
                    playLoop();
                } else {
                    stop();
                }
            });

            var redrawUntil = function(targetTime) {
                if (time < targetTime) {
                    while (time < targetTime) {
                        commands[time].forward();
                        time++;
                    }
                } else {
                    while (time > targetTime) {
                        time--;
                        commands[time].backward();
                    }
                }
                layout.repaint();
            }

            $("#time").on("input", function() {
                redrawUntil($(this).val());
            });

            // redrawUntil(events.length / 2);
        });

        function processEvents(events, layout) {
            var existingNodes = {};
            var commands = [];
            events.forEach(function(event) {
                var existingNode = existingNodes[event.path];
                if (existingNode) {
                    var nextState = event.state;
                    var previousState = existingNode.state;
                    commands.push({
                        forward: function() {
                            console.log("-> " + event.path + ": " + previousState + " -> " + nextState);
                            layout.setState(event.path, nextState);
                        },
                        backward: function() {
                            console.log("<- " + event.path + ": " + nextState + " -> " + previousState);
                            layout.setState(event.path, previousState);
                        }
                    });
                    existingNode.state = event.state;
                } else {
                    commands.push({
                        forward: function() {
                            console.log("++ " + event.path);
                            var parentPath;
                            if (event.path) {
                                var idx = event.path.lastIndexOf('.');
                                parentPath = idx === -1 ? "" : event.path.substring(0, idx);
                            } else {
                                parentPath = null;
                            }
                            layout.addNode(event.path, parentPath);
                        },
                        backward: function() {
                            console.log("-- " + event.path);
                            layout.removeNode(event.path);
                        }
                    });
                    existingNodes[event.path] = {
                        path: event.path,
                        state: event.state
                    };
                }
            });
            return commands;
        }
    </script>
</body>
</html>
