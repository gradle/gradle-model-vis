<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
    <style>
        svg {
        }

        .node {
            cursor: pointer;
        }

        circle {
            stroke-width: 1.5px;
        }

        .link {
            stroke: #999;
            stroke-opacity: .6;
            fill: none;
        }

        text {
            font-size: 10px;
            font-family: sans-serif;
            stroke: none;
            fill: black;
        }

        .controls,
        .controls button {
            font-family: monospace;
            font-size: 10pt;
        }

        .Registered { stroke: #aec7e8; fill: #FBFFFF; }
        .Discovered { stroke: #1f77b4; fill: #E1FAFF; }
        .Created { stroke: #2ca02c; fill: #C5FFC5; }
        .DefaultsApplied { stroke: #ffbb78; fill: #FFFFC5; }
        .Initialized { stroke: #ff7f0e; fill: #FFE574; }
        .Mutated { stroke: #d62728; fill: #FF8D8E; }
        .Finalized { stroke: #e377c2; fill: #FFDDFF; }
        .SelfClosed { stroke: #B2B2B2; fill: #E1E1E1; }
        .GraphClosed { stroke: #7f7f7f; fill: #CCCCCC; }
    </style>

    <script src="lib/d3.v3.js"></script>
    <script src="lib/underscore.js"></script>
    <script src="lib/jquery-2.2.0.min.js"></script>
    <script src="js/force-layout.js"></script>
    <script src="js/tree-layout.js"></script>
</head>
<body>
    <div class="controls">
        <button id="back">â€“</button>
        <input id="time" type="range" width="100" />
        <button id="forward">+</button>
        <button id="play-pause">&gt;&gt;</button>
    </div>
    <script>
        var width = 1600,
            height = 1000;

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        var legend = svg.selectAll(".legend")
            .data(["Registered", "Discovered", "Created", "DefaultsApplied", "Initialized", "Mutated", "Finalized", "SelfClosed", "GraphClosed"]);

        var legendGroup = legend.enter()
            .append("g")
            .attr("class", "legend");

        var legendCircle = legendGroup.append("circle")
            .attr("r", 6)
            .attr("cx", 8)
            .attr("cy", function(d, idx) {
                return 10 + idx * 18;
            })
            .attr("class", function (d) { return d; });

        var legendText = legendGroup.append("text")
            .attr("x", 20)
            .attr("y", function(d, idx) {
                return 13 + idx * 18;
            })
            .text(function(d) {
                return d;
            });
        legend.exit().remove();

        var dataFile = location.hash ? location.hash.substring(1) : "samples/gradle-model.json";
        console.log("Loading data file", dataFile);

        d3.json(dataFile, function(error, events) {
            if (error) throw error;

            var layout = new TreeLayout(d3, width, height);

            var commands = processEvents(events, layout);
            var time = 0;

            $("#time").attr({
                min: 0,
                max: events.length
            }).val(0);
            $("#back").click(function() {
                var value = parseInt($("#time").val());
                value = Math.max(0, value - 1);
                $("#time").val(value);
                $("#time").trigger("input");
            });
            $("#forward").click(function() {
                var value = parseInt($("#time").val());
                value = Math.min(events.length, value + 1);
                $("#time").val(value);
                $("#time").trigger("input");
            });
            var playing = false;
            var $playPause = $("#play-pause");
            $playPause.click(function() {
                var stop = function() {
                    playing = false;
                    $playPause.text(">>");
                };
                if (!playing) {
                    var playLoop = function() {
                        var $time = $("#time");
                        var cur = parseInt($time.val());
                        var max = parseInt($time.attr('max'));
                        if (cur < max) {
                            $("#forward").trigger("click");
                            if (playing) setTimeout(playLoop, 200);
                        } else {
                            stop();
                        }
                    };
                    playing = true;
                    $playPause.text("||");
                    playLoop();
                } else {
                    stop();
                }
            });

            var redrawUntil = function(targetTime) {
                if (time < targetTime) {
                    while (time < targetTime) {
                        commands[time].forward();
                        time++;
                    }
                } else {
                    while (time > targetTime) {
                        time--;
                        commands[time].backward();
                    }
                }
                layout.repaint();
            }

            $("#time").on("input", function() {
                redrawUntil(parseInt($(this).val()));
            });
        });

        function processEvents(events, layout) {
            var existingNodes = {};
            var commands = [];
            var multiproject = _.size(_.groupBy(events, function (e) { return e.project; }))>1;
            var normalizeEvent = function(event) {
                if (!multiproject) {
                    return;
                }
                if (event.project != '') {
                   var path = '<ROOT '+event.project+'>';
                   if (event.path != '') { path += '.' + event.path; }
                   event.path = path;
                }
            }
            var processEvent = function(event) {
                normalizeEvent(event);
                var existingNode = existingNodes[event.path];
                if (existingNode) {
                    var nextState = event.state;
                    var previousState = existingNode.state;
                    commands.push({
                        forward: function() {
                            console.log("-> " + event.path + ": " + previousState + " -> " + nextState);
                            layout.setState(event.path, nextState);
                        },
                        backward: function() {
                            console.log("<- " + event.path + ": " + nextState + " -> " + previousState);
                            layout.setState(event.path, previousState);
                        }
                    });
                    existingNode.state = event.state;
                } else {
                    commands.push({
                        forward: function() {
                            console.log("++ " + event.path);
                            layout.addNode(event.path);
                        },
                        backward: function() {
                            console.log("-- " + event.path);
                            layout.removeNode(event.path);
                        }
                    });
                    existingNodes[event.path] = {
                        path: event.path,
                        state: event.state
                    };
                }
            };
            if (multiproject) {
		    processEvent({ "project": '', "path": '', state: 'Registered'});
		    events.forEach(function (event) {
		        if (!existingNodes['<ROOT '+event.project+'>']) {
		              processEvent({ project:'', state: 'Registered', path: '<ROOT '+event.project+'>' });
		        }
		    });
            }
            events.forEach(processEvent);
            return commands;
        }
    </script>
</body>
</html>
